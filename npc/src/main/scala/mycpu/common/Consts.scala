package mycpu.common
import chisel3.util.BitPat

object Instructions {
  // 注意：BitPat 中的下划线 _ 只是为了可读性，会被忽略。
  // 关键是要凑齐 32 位。
  // 格式修正为: imm/func7(12) _ rs1/rs2(5) _ funct3(3) _ rd(5) _ opcode(7)

  // U-Type: imm[31:12] (20) _ rd (5) _ opcode (7)
  // 你之前的定义也是错的，长度不够
  def LUI    = BitPat("b????????????????????_?????_0110111")
  def AUIPC  = BitPat("b????????????????????_?????_0010111")

  // J-Type: imm(20) _ rd(5) _ opcode(7)
  def JAL    = BitPat("b????????????????????_?????_1101111")
  
  // I-Type: imm(12) _ rs1(5) _ funct3(3) _ rd(5) _ opcode(7)
  // [关键修复] 在 funct3 和 opcode 之间插入 5个? 代表 rd
  def JALR   = BitPat("b????????????_?????_000_?????_1100111")
  
  // B-Type: imm(12) _ rs2(5) _ rs1(5) _ funct3(3) _ imm(5) _ opcode(7) -> 其实就是 7+5+5+3+5+7 = 32
  // 但 Branch 指令没有 rd，格式是 imm[12|10:5] rs2 rs1 funct3 imm[4:1|11] opcode
  // BitPat 只要总位数对就行。
  // B-Type 其实可以写成: ???????_?????_?????_???_?????_1100011 (7+5+5+3+5+7 = 32)
  def BEQ    = BitPat("b???????_?????_?????_000_?????_1100011")
  def BNE    = BitPat("b???????_?????_?????_001_?????_1100011")
  def BLT    = BitPat("b???????_?????_?????_100_?????_1100011")
  def BGE    = BitPat("b???????_?????_?????_101_?????_1100011")
  def BLTU   = BitPat("b???????_?????_?????_110_?????_1100011")
  def BGEU   = BitPat("b???????_?????_?????_111_?????_1100011")

  // I-Type Load
  def LB     = BitPat("b????????????_?????_000_?????_0000011")
  def LH     = BitPat("b????????????_?????_001_?????_0000011")
  def LW     = BitPat("b????????????_?????_010_?????_0000011")
  def LBU    = BitPat("b????????????_?????_100_?????_0000011")
  def LHU    = BitPat("b????????????_?????_101_?????_0000011")

  // S-Type Store: imm(7) _ rs2(5) _ rs1(5) _ funct3(3) _ imm(5) _ opcode(7)
  def SB     = BitPat("b???????_?????_?????_000_?????_0100011")
  def SH     = BitPat("b???????_?????_?????_001_?????_0100011")
  def SW     = BitPat("b???????_?????_?????_010_?????_0100011")

  // I-Type ALU
  def ADDI   = BitPat("b????????????_?????_000_?????_0010011")
  def SLTI   = BitPat("b????????????_?????_010_?????_0010011")
  def SLTIU  = BitPat("b????????????_?????_011_?????_0010011")
  def XORI   = BitPat("b????????????_?????_100_?????_0010011")
  def ORI    = BitPat("b????????????_?????_110_?????_0010011")
  def ANDI   = BitPat("b????????????_?????_111_?????_0010011")
  
  // Shift I-Type (Shamt is 5 bits, imm high is 7 bits 0)
  // 7(0) _ 5(shamt) _ 5(rs1) _ 3(funct3) _ 5(rd) _ 7(opcode)
  def SLLI   = BitPat("b0000000?????_?????_001_?????_0010011")
  def SRLI   = BitPat("b0000000?????_?????_101_?????_0010011")
  def SRAI   = BitPat("b0100000?????_?????_101_?????_0010011")

  // R-Type: funct7(7) _ rs2(5) _ rs1(5) _ funct3(3) _ rd(5) _ opcode(7)
  def ADD    = BitPat("b0000000_?????_?????_000_?????_0110011")
  def SUB    = BitPat("b0100000_?????_?????_000_?????_0110011")
  def SLL    = BitPat("b0000000_?????_?????_001_?????_0110011")
  def SLT    = BitPat("b0000000_?????_?????_010_?????_0110011")
  def SLTU   = BitPat("b0000000_?????_?????_011_?????_0110011")
  def XOR    = BitPat("b0000000_?????_?????_100_?????_0110011")
  def SRL    = BitPat("b0000000_?????_?????_101_?????_0110011")
  def SRA    = BitPat("b0100000_?????_?????_101_?????_0110011")
  def OR     = BitPat("b0000000_?????_?????_110_?????_0110011")
  def AND    = BitPat("b0000000_?????_?????_111_?????_0110011")
  
  // CSR Instructions (I-Type)
  def CSRRW  = BitPat("b????????????_?????_001_?????_1110011")
  def CSRRS  = BitPat("b????????????_?????_010_?????_1110011")
  def CSRRC  = BitPat("b????????????_?????_011_?????_1110011")
  def CSRRWI = BitPat("b????????????_?????_101_?????_1110011")
  def CSRRSI = BitPat("b????????????_?????_110_?????_1110011")
  def CSRRCI = BitPat("b????????????_?????_111_?????_1110011")
  
  // System
  // imm(12) _ rs1(5) _ funct3(3) _ rd(5) _ opcode(7)
  // ECALL: imm=0, rs1=0, rd=0
  def ECALL  = BitPat("b000000000000_00000_000_00000_1110011")
  def EBREAK = BitPat("b000000000001_00000_000_00000_1110011")
  def MRET   = BitPat("b001100000010_00000_000_00000_1110011")
}